rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    // Allow admin via custom claim OR via config/allowlist.adminEmails
    function isAllowlistAdmin() {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/config/allowlist) &&
        get(/databases/$(database)/documents/config/allowlist).data.adminEmails.hasAny([request.auth.token.email]);
    }

    function isAdmin() {
      return isSignedIn() && (request.auth.token.admin == true || isAllowlistAdmin());
    }

    // Determine if current user belongs to a class
    // Assumes class doc may include one or more of: members (array of UIDs), instructorId (UID), ownerEmail (email)
    function isClassMember(classId) {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/classes/$(classId)) && (
          request.auth.uid == get(/databases/$(database)/documents/classes/$(classId)).data.instructorId ||
          request.auth.token.email == get(/databases/$(database)/documents/classes/$(classId)).data.ownerEmail ||
          (get(/databases/$(database)/documents/classes/$(classId)).data.members != null &&
            request.auth.uid in get(/databases/$(database)/documents/classes/$(classId)).data.members)
        );
    }

    // Activities â€” documents (not files)
    match /activities/{id} {
      allow read: if true;        // anyone can read activities
      allow write: if isAdmin();  // only admin can create/update/delete
    }

    // Announcements: admin write, any signed-in user can read
    match /announcements/{announcementId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /config/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Courses/Categories: admin write, public read
    match /courses/{courseId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Login logs: admin only
    match /loginLogs/{logId} {
      allow read, write: if isAdmin();
    }

    // Users collection
    // - Users can read their own document
    // - Admins can read/write any user document
    // - Any signed-in user can read user docs (for leaderboard/search)
    match /users/{userId} {
      // Read: any signed-in user
      allow read: if isSignedIn();

      // Write: the user themselves OR an admin
      allow write: if (isSignedIn() && request.auth.uid == userId) || isAdmin();
    }

    // Leaderboard: public read; only signed-in can write
    match /leaderboard/{doc} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    // Resources (like Blackboard): public read, admin write
    match /resources/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Chat messages with class-based access control
    match /messages/{messageId} {
      // Read: global messages for everyone, class messages for class members, DM messages for participants
      allow read: if isSignedIn() && (
        resource.data.type == 'global' ||
        isClassMember(resource.data.classId) ||
        (resource.data.type == 'dm' && request.auth.uid in get(/databases/$(database)/documents/directRooms/$(resource.data.roomId)).data.participants) ||
        isAdmin()
      );

      // Create: any signed-in user can create messages
      allow create: if isSignedIn() && request.resource.data.senderId == request.auth.uid;

      // Update rules:
      // - Sender or admin can update any fields.
      // - Any signed-in user may update only pollVotes, reactions, and readBy (to allow voting/reactions/receipts).
      allow update: if isSignedIn() && (
        resource.data.senderId == request.auth.uid ||
        isAdmin() ||
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['pollVotes', 'reactions', 'readBy'])
      );

      // Delete: only admin or message sender
      allow delete: if isAdmin() || (isSignedIn() && request.auth.uid == resource.data.senderId);
    }

    // Email logs (admin only)
    match /emailLogs/{logId} {
      allow read, write: if isAdmin();
    }

    // Email templates (admin only)
    match /emailTemplates/{templateId} {
      allow read, write: if isAdmin();
    }

    // Classes/Subjects: Admin write, authenticated read
    match /classes/{classId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Enrollments: Admin write, user can read their own enrollment
    match /enrollments/{enrollmentId} {
      allow read: if isAdmin() || (isSignedIn() && request.auth.uid == resource.data.userId);
      allow write: if isAdmin();
    }

    // Homework Submissions: tracks metadata about uploaded files
    match /submissions/{submissionId} {
      // User can create their own submission record.
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;

      // User can read their own submissions, admin can read all.
      allow read: if isAdmin() || (isSignedIn() && request.auth.uid == resource.data.userId);

      // User can update if not reviewed; Admin can always update.
      allow update: if isAdmin() || (isSignedIn() && request.auth.uid == resource.data.userId && !resource.data.reviewedAt);

      // Only admin can delete.
      allow delete: if isAdmin();
    }

    // Notifications: users can read their own; any signed-in user can create
    match /notifications/{notificationId} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId || isAdmin();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin() || (isSignedIn() && request.auth.uid == resource.data.userId);
    }

    // Direct message rooms: users can create/read rooms they're part of
    match /directRooms/{roomId} {
      allow read: if isSignedIn() && (
        request.auth.uid in resource.data.participants || isAdmin()
      );
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participants;
      allow update: if isSignedIn() && request.auth.uid in resource.data.participants;
      allow delete: if isAdmin();
    }

    // Attendance sessions
    match /attendanceSessions/{sessionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn(); // Further checks in function
      allow update, delete: if isAdmin() || (isSignedIn() && resource.data.createdBy == request.auth.uid);

      match /marks/{userId} {
        allow read: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
        allow write: if isSignedIn(); // Further checks in function
      }

      match /events/{eventId} {
        allow read: if isAdmin();
        allow create: if isSignedIn(); // Function-based
      }
    }

    // Quizzes: Creator and admins can write, visibility-based read
    match /quizzes/{quizId} {
      // Read rules based on visibility
      allow read: if isSignedIn() && (
        resource.data.visibility == 'public' ||
        resource.data.createdBy == request.auth.uid ||
        isAdmin() ||
        (resource.data.visibility == 'class' && resource.data.assignedClassIds != null && 
         resource.data.assignedClassIds.hasAny([request.auth.uid])) // Simplified class check
      );
      
      // Create: any signed-in user
      allow create: if isSignedIn() && request.resource.data.createdBy == request.auth.uid;
      
      // Update/Delete: creator or admin
      allow update, delete: if isAdmin() || (isSignedIn() && resource.data.createdBy == request.auth.uid);
    }

    // Quiz Submissions: Students can create/read their own, creators can read all for their quizzes
    match /quizSubmissions/{submissionId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        isAdmin() ||
        get(/databases/$(database)/documents/quizzes/$(resource.data.quizId)).data.createdBy == request.auth.uid
      );
      allow update: if isAdmin() || 
        (isSignedIn() && resource.data.userId == request.auth.uid) ||
        (isSignedIn() && get(/databases/$(database)/documents/quizzes/$(resource.data.quizId)).data.createdBy == request.auth.uid);
      allow delete: if isAdmin();
    }

    // Quiz Folders: Creator and admins can manage
    match /quizFolders/{folderId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isAdmin() || (isSignedIn() && resource.data.ownerId == request.auth.uid);
    }

    // Student Progress: Users can read/write their own, admins/instructors can read all
    match /studentProgress/{userId} {
      allow read: if isSignedIn() && (
        request.auth.uid == userId ||
        isAdmin() ||
        request.auth.token.instructor == true
      );
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && (
        request.auth.uid == userId ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }

    // Activity Logs: Users can create their own, admins can read all
    match /activityLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    // Flat attendance collection used by dashboard and legacy attendance APIs
    match /attendance/{recordId} {
      // Students can read their own records; admins can read all
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.studentId ||
        isAdmin()
      );

      // Only admins can write/delete attendance records from the client
      allow create, update, delete: if isAdmin();
    }

    // User badges (achievements) used by dashboard
    match /userBadges/{badgeId} {
      // Students can read their own badges; admins can read all
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        isAdmin()
      );

      // Students can create their own badge docs (if any client-side flow does this); admins can manage all
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update, delete: if isAdmin();
    }
  }
}
